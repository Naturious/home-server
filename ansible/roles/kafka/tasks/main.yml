---
- name: Ensure Docker network for Kafka exists
  community.docker.docker_network:
    name: "{{ kafka_network_name }}"

- name: Run Zookeeper container
  community.docker.docker_container:
    name: "{{ zookeeper_container_name }}"
    image: "{{ kafka_zookeeper_image }}"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: "{{ kafka_network_name }}"
    env:
      ZOO_ENABLE_AUTH: "no"
      ZOO_CLIENT_PORT_NUMBER: "2181"

- name: Run Kafka broker container
  community.docker.docker_container:
    name: "{{ kafka_container_name }}"
    image: "{{ kafka_image }}"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: "{{ kafka_network_name }}"
    env:
      KAFKA_CFG_ZOOKEEPER_CONNECT: "{{ zookeeper_container_name }}:2181"
      KAFKA_CFG_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
      ALLOW_PLAINTEXT_LISTENER: "yes"
    published_ports:
      - "9092:9092"

# Optional: create topic explicitly (Bitnami image has kafka-topics.sh)
- name: Create WhatsApp topic if needed
  community.docker.docker_container_exec:
    container: "{{ kafka_container_name }}"
    command: >
      kafka-topics.sh --create
      --if-not-exists
      --topic {{ kafka_topic_whatsapp }}
      --bootstrap-server localhost:9092
  register: create_topic_result
  changed_when: "'Created topic' in create_topic_result.stdout"

